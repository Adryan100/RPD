#!/usr/bin/perl
# -- radioc -- 
# client for radiod
use strict;
use Radiod::URI qw(geturi listchans getchname);
use Data::Dumper;

my $options; 
my $action = shift;
my $arg    = shift;
my $pipe_w = "$ENV{HOME}/.mplayer/radiod.fifo";
my $log    = "$ENV{HOME}/.mplayer/radiod.log";


$options = {
  quit    => sub {fifo_w($action);},
  stop    => sub {fifo_w('pause');}, # stop kills the player
  pause   => sub {fifo_w($action);},
  son     => sub {fifo_w($action);},
  soff    => sub {fifo_w($action);},
  change  => sub {
    fifo_w('loadfile ',geturi($arg));
    print "Playing ". getchname($arg), "\n   From ", geturi($arg),"\n";
  },
  np      => sub {print np(), "\n";},
  help    => sub {printf("%-15s\n",$_) for sort(keys %{$options});},
  list    => sub {listchans();},
  'help++'=> sub {usage();},
};


$options->{'help++'}->() unless $action;
defined $options->{$action} && $options->{$action}->();

sub fifo_w {
  my $action = shift;
  my $arg    = shift;
  my $fh;
  open(my $fh, '>', $pipe_w) or die "Can not open $pipe_w for writing: $!";
  print {$fh} "$action $arg\n";
}

sub np {
  open(my $fh, '<', $log) or die "Can not open $log for reading:  $!";
  my @content = <$fh>;
  close($fh);
  
  my @npinfo = grep(/ICY/g, @content);
  my @chinfo = grep(/^Website/g, @content);
  my $np     = $npinfo[@npinfo-1];
  $np =~ s/ICY Info: StreamTitle='//;
  $np =~ s/.;//;
  $np =~ s/Stream.+//;

  my $channel = $chinfo[@chinfo-1];
  $channel =~ s/Website: //;
  chomp($np, $channel);
  my $npinfo = sprintf("np: %s (%s)", $np, $channel);
  return $npinfo;
}

sub usage {
  print << "USAGE";
  Usage: $0 command (arg)
    COMMANDS
USAGE

  $options->{help}->();

  print << "LISTCHANGE";

  Change channel using the 'change' command.
  Each channel responds to a key.

  EXAMPLES
    $0 change psy
    $0 change hardcore
    $0 change p3

    Try $0 list to see available channels
LISTCHANGE
}
